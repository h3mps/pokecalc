<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'>
    <title>Form page</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js'></script>
    <style>
        h1 {
            font-family: "Copperplate Gothic";
            text-align: center;
        }

        input[type=text] {
            padding: 2px 2px;
            margin: 1px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input[type=submit] {
            background-color: #4CAF50;
            color: white;
            padding: 8px 8px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            font-family: "Verdana";
        }

            input[type=submit]:hover {
                background-color: #45a049;
            }

        select {
            width: 100%;
        }

        .calcleft {
            float: left;
            width: 48%;
        }

        .calcright {
            float: right;
            width: 48%;
        }

        .calcname {
            text-align: center;
            font-weight: bold;
            font-size: 15px;
        }

        .calcmovebox {
            display: block;
            background-color: azure;
            border-radius: 25px;
            border: 2px solid black;
            padding: 5px;
        }

        .calcmovebox:empty {
            background-color:inherit;
            border: none;
        }


        .movecalc {
            display: block;
            padding: 5px;
            border-radius: 10px;
        }

        #pokecalc {
            font-family: Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            table-layout: fixed;
        }

            #pokecalc td, #pokecalc th {
                border: 1px solid #ddd;
                padding: 8px;
                width: 275px;
                min-width: 275px;
                font-size: 14px;
            }

            #pokecalc tr:nth-child(even) {
                background-color: #f2f2f2;
            }

            #pokecalc th {
                padding-top: 12px;
                padding-bottom: 12px;
                text-align: left;
                background-color: #4CAF50;
                color: white;
            }
    </style>
    
</head>
<body>
    <header>
        <h1> My Pokemon Calculator </h1>
    </header>
    <form method="POST" action="/">
        <div style="overflow-x:auto;">
            <table id="pokecalc" cellpadding="1">
                <tr>
                    <td></td>
                    <td>
                        <input list="dsets1" class="setinput" name="dsl1" id="dsl1" onfocus="this.value=''" placeholder="Set 1">
                        <datalist id="dsets1" class="setinputlist"></datalist> <br />
                        <input type="text" name="dname" placeholder="Defender 1">
                        <input type="text" name="dmname1" placeholder="Move Slot 1"><br>
                        <input type="text" name="dmname2" placeholder="Move Slot 2"><br>
                        <input type="text" name="dmname3" placeholder="Move Slot 3"><br>
                        <input type="text" name="dmname4" placeholder="Move Slot 4"><br>
                    </td>
                    <td>
                        <input list="dsets2" class="setinput" name="dsl2" id="dsl2" onfocus="this.value=''" placeholder="Set 2">
                        <datalist id="dsets2" class="setinputlist"></datalist> <br />
                        <input type="text" name="dname" placeholder="Defender 2">
                        <input type="text" name="dmname1" placeholder="Move Slot 1"><br>
                        <input type="text" name="dmname2" placeholder="Move Slot 2"><br>
                        <input type="text" name="dmname3" placeholder="Move Slot 3"><br>
                        <input type="text" name="dmname4" placeholder="Move Slot 4"><br>
                    </td>
                    <td>
                        <input list="dsets3" class="setinput" name="dsl3" id="dsl3" onfocus="this.value=''" placeholder="Set 3">
                        <datalist id="dsets3" class="setinputlist"></datalist> <br />
                        <input type="text" name="dname" placeholder="Defender 3">
                        <input type="text" name="dmname1" placeholder="Move Slot 1"><br>
                        <input type="text" name="dmname2" placeholder="Move Slot 2"><br>
                        <input type="text" name="dmname3" placeholder="Move Slot 3"><br>
                        <input type="text" name="dmname4" placeholder="Move Slot 4"><br>
                    </td>
                    <td>
                        <input list="dsets4" class="setinput" name="dsl4" id="dsl4" onfocus="this.value=''" placeholder="Set 4">
                        <datalist id="dsets4" class="setinputlist"></datalist> <br />
                        <input type="text" name="dname" placeholder="Defender 4">
                        <input type="text" name="dmname1" placeholder="Move Slot 1"><br>
                        <input type="text" name="dmname2" placeholder="Move Slot 2"><br>
                        <input type="text" name="dmname3" placeholder="Move Slot 3"><br>
                        <input type="text" name="dmname4" placeholder="Move Slot 4"><br>
                    </td>
                    <td>
                        <input list="dsets5" class="setinput" name="dsl5" id="dsl5" onfocus="this.value=''" placeholder="Set 5">
                        <datalist id="dsets5" class="setinputlist"></datalist> <br />
                        <input type="text" name="dname" placeholder="Defender 5">
                        <input type="text" name="dmname1" placeholder="Move Slot 1"><br>
                        <input type="text" name="dmname2" placeholder="Move Slot 2"><br>
                        <input type="text" name="dmname3" placeholder="Move Slot 3"><br>
                        <input type="text" name="dmname4" placeholder="Move Slot 4"><br>
                    </td>
                    <td>
                        <input list="dsets6" class="setinput" name="dsl6" id="dsl6" onfocus="this.value=''" placeholder="Set 6">
                        <datalist id="dsets6" class="setinputlist"></datalist> <br />
                        <input type="text" name="dname" placeholder="Defender 6">
                        <input type="text" name="dmname1" placeholder="Move Slot 1"><br>
                        <input type="text" name="dmname2" placeholder="Move Slot 2"><br>
                        <input type="text" name="dmname3" placeholder="Move Slot 3"><br>
                        <input type="text" name="dmname4" placeholder="Move Slot 4"><br>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input list="asets1" class="setinput" name="asl1" id="asl1" onfocus="this.value=''" placeholder="Set 1">
                        <datalist id="asets1" class="setinputlist"></datalist> <br />
                        <input type="text" name="aname" placeholder="Attacker 1"><br>
                        <input type="text" name="amname1" placeholder="Move Slot 1"><br>
                        <input type="text" name="amname2" placeholder="Move Slot 2"><br>
                        <input type="text" name="amname3" placeholder="Move Slot 3"><br>
                        <input type="text" name="amname4" placeholder="Move Slot 4"><br>
                    </td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                </tr>
                <tr>
                    <td>
                        <input list="asets2" class="setinput" name="asl2" id="asl2" onfocus="this.value=''" placeholder="Set 2">
                        <datalist id="asets2" class="setinputlist"></datalist> <br />
                        <input type="text" name="aname" placeholder="Attacker 2"><br>
                        <input type="text" name="amname1" placeholder="Move Slot 1"><br>
                        <input type="text" name="amname2" placeholder="Move Slot 2"><br>
                        <input type="text" name="amname3" placeholder="Move Slot 3"><br>
                        <input type="text" name="amname4" placeholder="Move Slot 4"><br>
                    </td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                </tr>
                <tr>
                    <td>
                        <input list="asets3" class="setinput" name="asl3" id="asl3" onfocus="this.value=''" placeholder="Set 3">
                        <datalist id="asets3" class="setinputlist"></datalist> <br />
                        <input type="text" name="aname" placeholder="Attacker 3"><br>
                        <input type="text" name="amname1" placeholder="Move Slot 1"><br>
                        <input type="text" name="amname2" placeholder="Move Slot 2"><br>
                        <input type="text" name="amname3" placeholder="Move Slot 3"><br>
                        <input type="text" name="amname4" placeholder="Move Slot 4"><br>
                    </td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                </tr>
                <tr>
                    <td>
                        <input list="asets4" class="setinput" name="asl4" id="asl4" onfocus="this.value=''" placeholder="Set 4">
                        <datalist id="asets4" class="setinputlist"></datalist> <br />
                        <input type="text" name="aname" placeholder="Attacker 4"><br>
                        <input type="text" name="amname1" placeholder="Move Slot 1"><br>
                        <input type="text" name="amname2" placeholder="Move Slot 2"><br>
                        <input type="text" name="amname3" placeholder="Move Slot 3"><br>
                        <input type="text" name="amname4" placeholder="Move Slot 4"><br>
                    </td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                </tr>
                <tr>
                    <td>
                        <input list="asets5" class="setinput" name="asl5" id="asl5" onfocus="this.value=''" placeholder="Set 5">
                        <datalist id="asets5" class="setinputlist"></datalist> <br />
                        <input type="text" name="aname" placeholder="Attacker 5"><br>
                        <input type="text" name="amname1" placeholder="Move Slot 1"><br>
                        <input type="text" name="amname2" placeholder="Move Slot 2"><br>
                        <input type="text" name="amname3" placeholder="Move Slot 3"><br>
                        <input type="text" name="amname4" placeholder="Move Slot 4"><br>
                    </td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td></td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                </tr>
                <tr>
                    <td>
                        <input list="asets6" class="setinput" name="asl6" id="asl6" onfocus="this.value=''" placeholder="Set 6">
                        <datalist id="asets6" class="setinputlist"></datalist> <br />
                        <input type="text" name="aname" placeholder="Attacker 6"><br>
                        <input type="text" name="amname1" placeholder="Move Slot 1"><br>
                        <input type="text" name="amname2" placeholder="Move Slot 2"><br>
                        <input type="text" name="amname3" placeholder="Move Slot 3"><br>
                        <input type="text" name="amname4" placeholder="Move Slot 4"><br>
                    </td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                </tr>
            </table>
        </div>
        <div><input type="submit" value="Calculate"></div>
    </form>

    <script>
        $(document).ready(function () {
            let url = 'http://localhost:3000/sets';
            $.getJSON(url, function (data) {
                $('.setinputlist').each(function () {
                    var thisEntry = this
                    $.each(data, function (key, entry) {
                        $.each(entry, function (i, val) {
                            var option = $('<option value="' + key + " (" + i + ")" + '"></option>');
                            $(thisEntry).append(option);
                        });
                    });
                });
            });

        });
    </script>

    <script>
        $('.setinput').on('input', function (event) {
            var targid = event.target.id;
            var r = targid.charAt(0);
            var num = targid.replace(/[^0-9]/g, '');

            // Recover JSON values
            var ci = $('#' + targid).val();
            var fb = ci.indexOf("(");
            var len = ci.length;
            var chosenmon = ci.substring(0, fb - 1);
            var chosenset = ci.substring(fb + 1, len-1)

            document.querySelectorAll("[name=" + r + "name]")[num - 1].value = chosenmon;

            $.getJSON('http://localhost:3000/sets', function (data) {
                document.querySelectorAll("[name=" + r + "mname1]")[num - 1].value = data[chosenmon][chosenset].moves[0];
                document.querySelectorAll("[name=" + r + "mname2]")[num - 1].value = data[chosenmon][chosenset].moves[1];
                document.querySelectorAll("[name=" + r + "mname3]")[num - 1].value = data[chosenmon][chosenset].moves[2];
                document.querySelectorAll("[name=" + r + "mname4]")[num - 1].value = data[chosenmon][chosenset].moves[3];
            });
        });



    </script>


    <script>
        $('form').on('submit', makeRequest);
        function makeRequest(e) {
            e.preventDefault();
            var myTab = document.getElementById('pokecalc');
            

            for (let i = 0; i < myTab.rows.length - 1; i++) {

                // GET THE CELLS COLLECTION OF THE CURRENT ROW.
                var objCells = myTab.rows.item(i).cells;

                var rowname = document.querySelectorAll('[name="aname"]')[i].value;

                // LOOP THROUGH EACH CELL OF THE CURRENT ROW TO READ CELL VALUES.
                for (let j = 0; j < objCells.length - 1; j++) {
                    var colname = document.querySelectorAll('[name="dname"]')[j].value;

                    myTab.rows[i + 1].cells[j + 1].innerHTML = '';

                    for (let d = 0; d < 2; d++) {
                        if (d == 0) {
                            myTab.rows[i + 1].cells[j + 1].innerHTML = "<div class = calcleft><div class = calcname id = calcname" + i + j + "0></div><div class = calcmovebox id = box" + i + j + "0></div></div><div class = calcright><div class = calcname id = calcname" + i + j + "1></div><div class = calcmovebox id = box" + i + j + "1></div></div>";
                        }

                        for (let m = 1; m < 5; m++) {
                            if (d == 0) {
                                var aname = rowname;
                                var dname = colname;
                                var mname = document.querySelectorAll("[name=amname" + m + "]")[i].value;
                            }
                            else if (d == 1) {
                                var aname = colname;
                                var dname = rowname;
                                var mname = document.querySelectorAll("[name=dmname" + m + "]")[j].value;
                            }

                            var formData = {
                                'aname': aname,
                                'dname': dname,
                                'mname': mname
                            };

                            if (aname == "" || dname == "" || mname == "") {
                                console.log('Missing field')
                            } else {
                                $.ajax({
                                    url: '/',
                                    type: 'POST',
                                    data: formData,
                                    success: function (data) {
                                        onSuccess(data, i, j, myTab, d);
                                    },
                                    error: function () {
                                        myTab.rows[i + 1].cells[j + 1].innerHTML = '';
                                    }
                                });

                            }

                        }

                    }

                }
            }
        }
        function onSuccess(data, i, j, myTab, d, m) {
            var lbound = 100 * data.damage[0] / data.defender.originalCurHP;
            var ubound = 100 * data.damage[15] / data.defender.originalCurHP;
            var lb = lbound.toFixed(1);
            var ub = ubound.toFixed(1);
            if (ub == "NaN") {
                var damageRa = '0-0%'
            }
            else {
                var damageRa = lb + '% - ' + ub + '%';
            }

            // myTab.rows[i + 1].cells[j + 1].innerHTML += "<div class=movecalc>" + damageRa + "</div>";
            var a0 = "calcname" + i + j + "0";
            var a1 = "calcname" + i + j + "1";
            var b = "box" + i + j + d;
            document.getElementById(a0).innerHTML = data.defender.name;
            document.getElementById(a1).innerHTML = data.attacker.name;
            document.getElementById(b).innerHTML += "<div class=movecalc>" + damageRa + "</div>";

            console.log(myTab.rows[i + 1].cells[j + 1].outerHTML)
            
        }
    </script>



</body>
</html>